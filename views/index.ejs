<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta property='twitter:image' content="<%= ogp_image_url %>" />
    <meta property="og:image" content="<%= ogp_image_url %>" />

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" href="css/fontawesome/css/all.min.css">
    <link rel="stylesheet" href="css/share_sheet.css">
    <link rel="stylesheet" href="css/button.css">

    <link rel="apple-touch-icon" sizes="57x57" href="images/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="images/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="images/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="images/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="images/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="images/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="images/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="images/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="images/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

    <style type="text/css">
      .ace_editor {
        height: 600px;
        padding: 0;
        margin: 0;
      }
      .no-gutters {
        margin-right: 0;
        margin-left: 0;

        > .col,
        > [class*="col-"] {
          padding-right: 0;
          padding-left: 0;
        }
      }
      /* Sticky footer styles */
      html {
        position: relative;
        min-height: 100%;
      }
      body {
        margin-bottom: 60px; /* Margin bottom by footer height */
      }
      .footer {
        position: absolute;
        bottom: 0;
        width: 100%;
        height: 60px; /* Set the fixed height of the footer here */
        line-height: 60px; /* Vertically center the text there */
        background-color: #F7F7F7;
      }
    </style>

    <title>Swift Playground</title>
  </head>
  <body style="background-color: #F7F7F7; color: #333333;">
    <div class="container" style="margin-top: 30px;">
      <div class="row">
        <div class="col" style="margin-bottom: 15px;">
          <h4><%= title %></h4>
        </div>
        <div class="col-md-2">
          <form>
            <div class="form-group">
              <select class="form-control" id="versionSelect">
                <% versions.forEach(function (version) { %>
                <% var selected = ( version == default_version ) ? "selected" : ""; %>
                <option value="<%= version %>" <%= selected %>><%= version.replace('_', '/') %></option>
                <% }); %>
              </select>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="container-fluid" style="padding-right: 0; padding-left: 0; padding-bottom: 15px;">
      <div class="row no-gutters">
        <div class="col-md-6">
          <pre id="editor"><xmp><%- code %></xmp></pre>
        </div>
        <div class="col-md-6">
          <pre id="results-editor"></pre>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="row">
        <div class="col-md-3 mx-auto" style="margin-top: 20px; margin-bottom: 20px;">
          <button id="run-button" type="button" class="btn btn-primary btn-block btn-lg">Run&nbsp;&nbsp;<i class="fa fa-play" aria-hidden="true"></i></button>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="row">
        <div class="col text-center">
          <button type="button" class="btn btn-info btn-circle m-1" onclick="showShareSheet();"><i class="fa fa-share-alt" aria-hidden="true"></i></button>
          <button type="button" class="btn btn-secondary btn-circle m-1" data-toggle="modal" data-target="#helpSheet"><i class="fa fa-question" aria-hidden="true"></i></button>
        </div>
      </div>
    </div>

    <div class="modal fade" id="shareSheet" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content col-12">
          <div class="modal-header">
            <h5 class="modal-title">Share</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </div>
          <div class="modal-body">
            <div class="fluid">
              <a class="btn btn-sm btn-social btn-facebook" href="#" target="_blank" rel="nofollow noopener noreferrer" title="Share this post on Facebook">
                <i class="fab fa-facebook-square"></i> Facebook
              </a>
              <a class="btn btn-sm btn-social btn-twitter" href="#" target="_blank" rel="nofollow noopener noreferrer" title="Share this post on Twitter">
                <i class="fab fa-twitter"></i> Twitter
              </a>
              <a class="btn btn-sm btn-social btn-line" href="#" target="_blank" rel="nofollow noopener noreferrer" target="_blank" title="Share this post on Discord">
                <i class="fab fa-line"></i> LINE
              </a>
              <a class="btn btn-sm btn-social btn-pocket" href="#" target="_blank" rel="nofollow noopener noreferrer" target="_blank" title="Share this post on Slack">
                <i class="fab fa-get-pocket"></i> Pocket
              </a>
            </div>
          </div>
          <div class="modal-footer"><label style="font-weight: 600">Page Link <span class="share-sheet-copy-message"></span></label><br>
            <div class="fluid">
              <input class="ur" id="shared_link" type="url" disabled="disabled" aria-describedby="inputGroup-sizing-default" style="width: 96%; height: 40px;"> <button class="cpy" onclick="copySharedLink()"><i class="far fa-clone"></i></button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="helpSheet" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content col-12">
          <div class="modal-header">
            <h5 class="modal-title">Help</h5><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          </div>
          <div class="modal-body">
            <dl>
              <dt>Import</dt>
              <dd>There are a few different ways to import code into Playground:</dd>
            </dl>
            <ul>
              <li>Drop a file onto the editor</li>
              <li>Append a GitHub gist ID to the URL<br>(e.g. <code>swift-playground.kishikawakatsumi.com/<code style="background-color: #F0F0F0; padding: 2px;">&lt;gist_id_goes_here&gt;</code></code>)</li>
              <li>Or just start typing!</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <footer class="footer">
      <div class="container">
        <div class="row">
          <div class="mx-auto">
            <a href="https://github.com/kishikawakatsumi/swift-playground" style="color: #999999;"><i class="fa fa-github fa-2x"></i></a>
          </div>
        </div>
      </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>

    <script src="https://pagecdn.io/lib/ace/1.4.12/ace.min.js" crossorigin="anonymous" integrity="sha256-T5QdmsCQO5z8tBAXMrCZ4f3RX8wVdiA0Fu17FGnU1vU="></script>
    <script src="https://pagecdn.io/lib/ace/1.4.12/ext-language_tools.min.js" crossorigin="anonymous"></script>
    <script src="https://pagecdn.io/lib/ace/1.4.12/theme-xcode.min.js" crossorigin="anonymous"></script>
    <script src="https://pagecdn.io/lib/ace/1.4.12/theme-terminal.min.js" crossorigin="anonymous"></script>
    <script src="https://pagecdn.io/lib/ace/1.4.12/mode-swift.min.js" crossorigin="anonymous"></script>

    <script type="text/javascript">
      ace.require("ace/ext/language_tools");
      const editor = ace.edit("editor");
      editor.setTheme("ace/theme/xcode");
      editor.session.setMode("ace/mode/swift");
      editor.$blockScrolling = Infinity
      editor.setOptions({
        useSoftTabs: true,
        autoScrollEditorIntoView: true,
        fontFamily: "menlo",
        fontSize: "11pt",
        showInvisibles: false,
        enableBasicAutocompletion: true,
        enableSnippets: true,
        enableLiveAutocompletion: true,
      });
      editor.renderer.setOptions({
        showFoldWidgets: false,
        showPrintMargin: false,
      });
      const row = editor.session.getLength() - 1
      const column = editor.session.getLine(row).length
      editor.gotoLine(row + 1, column)

      const resultsEditor = ace.edit("results-editor");
      resultsEditor.setTheme("ace/theme/terminal");
      resultsEditor.session.setMode("ace/mode/text");
      resultsEditor.$blockScrolling = Infinity
      resultsEditor.setOptions({
        readOnly: true,
        highlightActiveLine: false,
        highlightSelectedWord: false,
        autoScrollEditorIntoView: true,
      });
      resultsEditor.renderer.setOptions({
        showGutter: false,
        showPrintMargin: false,
        showInvisibles: false,
        fontFamily: "menlo",
        fontSize: "11pt",
      });
      resultsEditor.renderer.hideCursor();

      $("#run-button").click(function (e) {
        e.preventDefault();
        run($(this), editor);
      });

      function run(sender, editor) {
        const buttonTitle = deactivate(sender);
        const intid = showProgress(resultsEditor);
        const code = editor.getSession().getValue();
        const params = {
          toolchain_version: $("#versionSelect").val().replace('/', '_'),
          code: code
        };
        $.post('/run', params, function(data, error, xhr) {
          resultsEditor.setValue(data.version + data.errors + data.output);
          resultsEditor.clearSelection();
          clearInterval(intid);
          editor.focus();
          activate(sender, buttonTitle);
        });
      }

      function activate(button, buttonTitle) {
        button.prop("disabled", false);
        button.html(buttonTitle);
      }

      function deactivate(button) {
        button.prop("disabled", true);
        var buttonTitle = button.html();
        button.html('<i class="fa fa-circle-o-notch fa-spin" aria-hidden="true"></i> Processing...');
        resultsEditor.setValue("");
        return buttonTitle
      }

      function showProgress(editor) {
        let counter = 0
        return setInterval(function() {
          if (counter == 0) {
            resultsEditor.setValue('Executing...');
            counter += 1;
          } else {
            resultsEditor.setValue(resultsEditor.getSession().getValue() + '.');
          }
          resultsEditor.clearSelection();
        }, 1500);
      }
    </script>

    <script>
      function showShareSheet() {
        const code = editor.getSession().getValue();
        const params = {
          toolchain_version: $("#versionSelect").val().replace("/", "_"),
          code: code,
        };
        $.post("/shared_link", params, function (data, error, xhr) {
          if (data) {
            const url = data.shared_link.url
            $("#shared_link").val(url);
            $(".btn-facebook").attr("href", `https://www.facebook.com/sharer/sharer.php?u=${url}`)
            $(".btn-twitter").attr("href", `https://twitter.com/intent/tweet?text=&url=${url}`)
            $(".btn-line").attr("href", `https://social-plugins.line.me/lineit/share?url=${url}`)
            $(".btn-pocket").attr("href", `https://getpocket.com/edit?url=${url}`)
            $("#shareSheet").modal();
          }
        });
        $("#shareSheet").modal();
      }

      function copySharedLink() {
        if (navigator.clipboard) {
          navigator.clipboard.writeText($("#shared_link").val());
        }
        const message = $(".share-sheet-copy-message");
        message.hide();
        message.text("link copied!");
        message.fadeIn(500).delay(1000).fadeOut(500);
      }
    </script>

    <script>
      function handleFileSelect(evt) {
        evt.stopPropagation();
        evt.preventDefault();

        var files = evt.dataTransfer.files; // FileList object.
        var reader = new FileReader();
        reader.onload = function(event) {
          const editor = ace.edit("editor");
          editor.setValue(event.target.result);
          editor.clearSelection();
        }
        reader.readAsText(files[0],"UTF-8");
      }

      function handleDragOver(evt) {
        evt.stopPropagation();
        evt.preventDefault();
        evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
      }

      const dropZone = document.getElementById('editor');
      dropZone.addEventListener('dragover', handleDragOver, false);
      dropZone.addEventListener('drop', handleFileSelect, false);
    </script>
  </body>
</html>
